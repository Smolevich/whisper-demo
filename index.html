<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å–ª–∞–±–ª–µ–Ω –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –º–æ–∂–Ω–æ —É–∂–µ—Å—Ç–æ—á–∏—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com; connect-src 'self' https: data: blob:; worker-src 'self' blob:; style-src 'self' 'unsafe-inline';">
    <title>Whisper –≤ –±—Ä–∞—É–∑–µ—Ä–µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        select, input[type="text"] {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            display: block;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            display: block;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .progress.active {
            display: block;
            opacity: 1;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .result.active {
            display: block;
        }

        .result-text {
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .audio-player {
            width: 100%;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .model-info {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .accordion {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .accordion-header {
            width: 100%;
            padding: 12px 16px;
            background: #f8f9fa;
            border: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            transition: background 0.3s;
        }

        .accordion-header:hover {
            background: #e9ecef;
        }

        .accordion-icon {
            transition: transform 0.3s;
            font-size: 12px;
            margin-left: 8px;
        }

        .accordion.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: white;
        }

        .accordion.active .accordion-content {
            max-height: 2000px;
            padding: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Whisper –≤ –±—Ä–∞—É–∑–µ—Ä–µ</h1>
        <p class="subtitle">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∞—É–¥–∏–æ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
            <input type="file" id="fileInput" accept="audio/*,video/*">
        </div>

        <audio id="audioPlayer" class="audio-player" controls style="display: none;"></audio>

        <div class="controls">
            <div class="control-group">
                <label for="model">–ú–æ–¥–µ–ª—å</label>
                <select id="model">
                    <option value="Xenova/whisper-tiny">Tiny (–±—ã—Å—Ç—Ä–∞—è, –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ)</option>
                    <option value="Xenova/whisper-base" selected>Base (–±–∞–∑–æ–≤–∞—è, —Å—Ä–µ–¥–Ω–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)</option>
                    <option value="Xenova/whisper-small">Small (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)</option>
                    <option value="Xenova/whisper-medium">Medium (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è, –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ)</option>
                </select>
                <span class="model-info">‚ö†Ô∏è Base –º–æ–¥–µ–ª—å –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ. –î–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Small –∏–ª–∏ Medium. –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (>10 –º–∏–Ω) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è Tiny –∏–ª–∏ Base.</span>
            </div>
            
            <!-- Accordion –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
            <div class="accordion">
                <button class="accordion-header" type="button" id="advancedSettingsBtn">
                    <span>‚öôÔ∏è</span>
                    <span class="accordion-icon">‚ñº</span>
                </button>
                <div class="accordion-content" id="advancedSettings">
                    <div class="control-group">
                        <label for="modelType">–¢–∏–ø –º–æ–¥–µ–ª–∏</label>
                        <select id="modelType">
                            <option value="multilingual" selected>Multilingual (–º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è)</option>
                            <option value="english">English-only (—Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="task">–ó–∞–¥–∞—á–∞</label>
                        <select id="task">
                            <option value="transcribe" selected>Transcribe (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)</option>
                            <option value="translate">Translate (–ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="language">Source Language (—è–∑—ã–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞)</label>
                        <select id="language">
                            <option value="auto">Auto-detect (–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)</option>
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="en">English</option>
                            <option value="de">Deutsch</option>
                            <option value="fr">Fran√ßais</option>
                            <option value="es">Espa√±ol</option>
                            <option value="it">Italiano</option>
                            <option value="pt">Portugu√™s</option>
                            <option value="ja">Êó•Êú¨Ë™û</option>
                            <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                            <option value="zh">‰∏≠Êñá</option>
                            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                            <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                            <option value="tr">T√ºrk√ße</option>
                            <option value="pl">Polski</option>
                            <option value="nl">Nederlands</option>
                            <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                            <option value="cs">ƒåe≈°tina</option>
                            <option value="sv">Svenska</option>
                            <option value="no">Norsk</option>
                            <option value="fi">Suomi</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="outputFormats">–§–æ—Ä–º–∞—Ç—ã –≤—ã–≤–æ–¥–∞</label>
                        <div class="formats-checkboxes" id="formatsContainer">
                            <label><input type="checkbox" value="txt" checked> TXT (—Ç–µ–∫—Å—Ç)</label>
                            <label><input type="checkbox" value="srt" checked> SRT (—Å—É–±—Ç–∏—Ç—Ä—ã)</label>
                            <label><input type="checkbox" value="json"> JSON (—Å –º–µ—Ç–∫–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏)</label>
                            <label><input type="checkbox" value="vtt"> VTT (–≤–µ–±-—Å—É–±—Ç–∏—Ç—Ä—ã)</label>
                            <label><input type="checkbox" value="tsv"> TSV (—Ç–∞–±–ª–∏—Ü–∞)</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="transcribeBtn" disabled>
                –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button class="btn-secondary" id="stopBtn" disabled>
                –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            </button>
        </div>

        <div class="status" id="status"></div>
        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="result" id="result">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:</h3>
            <div class="result-text" id="resultText"></div>
            <div class="download-buttons" id="downloadButtons" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
        window.addEventListener('error', (e) => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}`;
                statusEl.className = 'status error';
            }
        });

        // Transformers.js - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ—Ç Hugging Face
        // –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/xenova/transformers.js
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: https://github.com/xenova/transformers.js/security
        // –ú–æ–¥–µ–ª–∏ Xenova –Ω–∞ HF: https://huggingface.co/Xenova
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –¥–ª—è –º–æ–¥–µ–ª–µ–π
        env.allowLocalModels = false;
        env.allowRemoteModels = true;
        env.useBrowserCache = true;
        
        // –ú–æ–¥–µ–ª–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ IndexedDB –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        // –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –∫—ç—à–∞ (–±—ã—Å—Ç—Ä–æ)
        // –ö—ç—à —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞

        let transcriber = null;
        let audioData = null;
        let isProcessing = false;
        let currentModel = null;
        let moduleLoaded = false;
        let progressInterval = null;
        let transcriptionTimeout = null;
        let heartbeatInterval = null;
        let worker = null; // Web Worker –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        const TRANSCRIPTION_TIMEOUT = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        const HEARTBEAT_INTERVAL = 1000; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web Worker –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
        function initWorker() {
            if (worker) return worker;
            
            try {
                // –°–æ–∑–¥–∞–µ–º Worker –∫–∞–∫ –º–æ–¥—É–ª—å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ import
                worker = new Worker('whisper-worker.js', { type: 'module' });
                
                worker.addEventListener('message', (e) => {
                    const { type, message, progress, error, result } = e.data;
                    
                    switch(type) {
                        case 'status':
                            showStatus(message, 'info');
                            break;
                            
                        case 'loadProgress':
                            const percent = Math.round(progress);
                            progressBar.style.width = `${20 + percent * 0.2}%`;
                            showStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${percent}%`, 'info');
                            break;
                            
                        case 'modelLoaded':
                            showStatus('–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                            break;
                            
                        case 'result':
                            handleTranscriptionResult(result);
                            break;
                            
                        case 'error':
                            showStatus(`–û—à–∏–±–∫–∞: ${error}`, 'error');
                            isProcessing = false;
                            transcribeBtn.disabled = false;
                            stopBtn.disabled = true;
                            progress.classList.remove('active');
                            break;
                            
                        case 'stopped':
                            showStatus('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
                            isProcessing = false;
                            transcribeBtn.disabled = false;
                            stopBtn.disabled = true;
                            progress.classList.remove('active');
                            break;
                    }
                });
                
                worker.addEventListener('error', (error) => {
                    console.error('Worker error:', error);
                    showStatus('–û—à–∏–±–∫–∞ Worker. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º.', 'error');
                    worker = null; // –û—Ç–∫–ª—é—á–∞–µ–º Worker –ø—Ä–∏ –æ—à–∏–±–∫–µ
                });
                
                return worker;
            } catch (error) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Worker:', error);
                return null; // Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–º–ø–æ—Ä—Ç –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
            moduleLoaded = true;
            console.log('Transformers.js –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Transformers.js:', e);
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                statusEl.className = 'status error';
            }
        }

        // –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (multilingual –∏ english-only)
        const trustedModels = [
            'Xenova/whisper-tiny',
            'Xenova/whisper-base',
            'Xenova/whisper-small',
            'Xenova/whisper-medium',
            'Xenova/whisper-tiny.en',
            'Xenova/whisper-base.en',
            'Xenova/whisper-small.en'
        ];

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (multilingual –∏ english-only)
        const modelConfigs = {
            'Xenova/whisper-tiny': {
                chunk_length_s: 30,
                stride_length_s: 5
            },
            'Xenova/whisper-base': {
                chunk_length_s: 30,
                stride_length_s: 5
            },
            'Xenova/whisper-small': {
                chunk_length_s: 30,
                stride_length_s: 3
            },
            'Xenova/whisper-medium': {
                chunk_length_s: 20,
                stride_length_s: 2
            },
            'Xenova/whisper-tiny.en': {
                chunk_length_s: 30,
                stride_length_s: 5
            },
            'Xenova/whisper-base.en': {
                chunk_length_s: 30,
                stride_length_s: 5
            },
            'Xenova/whisper-small.en': {
                chunk_length_s: 30,
                stride_length_s: 3
            }
        };

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
        function validateModel(modelName) {
            if (!trustedModels.includes(modelName)) {
                throw new Error('–ù–µ–¥–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å');
            }
            return true;
        }

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const audioPlayer = document.getElementById('audioPlayer');
        const transcribeBtn = document.getElementById('transcribeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        const result = document.getElementById('result');
        const resultText = document.getElementById('resultText');
        const languageSelect = document.getElementById('language');
        const modelSelect = document.getElementById('model');
        const modelTypeSelect = document.getElementById('modelType');
        const taskSelect = document.getElementById('task');
        const formatsContainer = document.getElementById('formatsContainer');
        const downloadButtons = document.getElementById('downloadButtons');
        const advancedSettingsBtn = document.getElementById('advancedSettingsBtn');
        const accordion = advancedSettingsBtn?.closest('.accordion');
        
        // Accordion –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        if (advancedSettingsBtn && accordion) {
            advancedSettingsBtn.addEventListener('click', () => {
                accordion.classList.toggle('active');
            });
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')},${ms.toString().padStart(3, '0')}`;
        }
        
        function formatTimeVTT(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
        }
        
        function generateSRT(chunks) {
            if (!chunks || chunks.length === 0) return '';
            return chunks.map((chunk, index) => {
                const start = formatTime(chunk.timestamp[0]);
                const end = formatTime(chunk.timestamp[1]);
                return `${index + 1}\n${start} --> ${end}\n${chunk.text}\n`;
            }).join('\n');
        }
        
        function generateVTT(chunks) {
            if (!chunks || chunks.length === 0) return '';
            let vtt = 'WEBVTT\n\n';
            chunks.forEach(chunk => {
                const start = formatTimeVTT(chunk.timestamp[0]);
                const end = formatTimeVTT(chunk.timestamp[1]);
                vtt += `${start} --> ${end}\n${chunk.text}\n\n`;
            });
            return vtt;
        }
        
        function generateTSV(chunks) {
            if (!chunks || chunks.length === 0) return '';
            let tsv = 'Start\tEnd\tText\n';
            chunks.forEach(chunk => {
                tsv += `${chunk.timestamp[0].toFixed(3)}\t${chunk.timestamp[1].toFixed(3)}\t${chunk.text}\n`;
            });
            return tsv;
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ (multilingual/english)
        function updateModelList() {
            if (!modelTypeSelect) return;
            
            const modelType = modelTypeSelect.value;
            const currentValue = modelSelect.value;
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            modelSelect.innerHTML = '';
            
            if (modelType === 'multilingual') {
                modelSelect.innerHTML = `
                    <option value="Xenova/whisper-tiny">Tiny (–±—ã—Å—Ç—Ä–∞—è, –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ)</option>
                    <option value="Xenova/whisper-base">Base (–±–∞–∑–æ–≤–∞—è, —Å—Ä–µ–¥–Ω–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)</option>
                    <option value="Xenova/whisper-small">Small (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)</option>
                    <option value="Xenova/whisper-medium">Medium (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è, –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ)</option>
                `;
            } else {
                modelSelect.innerHTML = `
                    <option value="Xenova/whisper-tiny.en">Tiny.en (–±—ã—Å—Ç—Ä–∞—è, —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)</option>
                    <option value="Xenova/whisper-base.en">Base.en (–±–∞–∑–æ–≤–∞—è, —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)</option>
                    <option value="Xenova/whisper-small.en">Small.en (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è, —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)</option>
                `;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ
            if (Array.from(modelSelect.options).some(opt => opt.value === currentValue)) {
                modelSelect.value = currentValue;
            } else {
                // –ò–Ω–∞—á–µ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –æ–ø—Ü–∏—é
                modelSelect.selectedIndex = 0;
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞
        if (modelTypeSelect) {
            modelTypeSelect.addEventListener('change', updateModelList);
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateModelList();
        }
        
        // Pre-warming –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ (–æ—Ç–∫–ª—é—á–µ–Ω–æ –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫, –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –ø—Ä–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏)
        // modelSelect.addEventListener('change', async () => {
        //     const modelName = modelSelect.value;
        //     if (currentModel !== modelName && !isProcessing) {
        //         try {
        //             validateModel(modelName);
        //             showStatus('–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...', 'info');
        //             transcriber = await pipeline('automatic-speech-recognition', modelName);
        //             currentModel = modelName;
        //             showStatus('–ú–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é', 'success');
        //             setTimeout(() => {
        //                 if (status.textContent.includes('–ú–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞')) {
        //                     status.classList.remove('success');
        //                     status.style.display = 'none';
        //                 }
        //             }, 2000);
        //         } catch (error) {
        //             console.error('–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', error);
        //             showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏', 'error');
        //         }
        //     }
        // });

        async function handleFile(file) {
            if (!file.type.startsWith('audio/') && !file.type.startsWith('video/')) {
                showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ —Ñ–∞–π–ª', 'error');
                return;
            }

            audioData = file;
            const url = URL.createObjectURL(file);
            audioPlayer.src = url;
            audioPlayer.style.display = 'block';
            transcribeBtn.disabled = false;
            result.classList.remove('active');
            showStatus(`–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${file.name}`, 'success');
        }

        transcribeBtn.addEventListener('click', async () => {
            if (!audioData || isProcessing) return;
            await transcribe();
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –≤ Worker –∏ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ)
        function handleTranscriptionResult(output) {
            progressBar.style.width = '100%';
            
            const modelName = modelSelect.value;
            const text = output.text || (output.chunks ? output.chunks.map(c => c.text).join(' ') : '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            if (text && text.length > 0) {
                const wordCount = text.split(/\s+/).length;
                const charCount = text.length;
                
                // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ - –≤–æ–∑–º–æ–∂–Ω–æ –ø–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
                if (modelName === 'Xenova/whisper-base' && charCount < 100 && audioData.size > 5 * 1024 * 1024) {
                    showStatus('–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∏–∑–∫–∏–º. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Small –∏–ª–∏ Medium –º–æ–¥–µ–ª—å –¥–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.', 'info');
                } else {
                    showStatus(`–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${wordCount} —Å–ª–æ–≤.`, 'success');
                }
            } else {
                showStatus('–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª.', 'error');
            }
            
            resultText.textContent = text;
            result.classList.add('active');
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
            const selectedFormats = Array.from(formatsContainer.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            downloadButtons.innerHTML = '';
            downloadButtons.style.display = selectedFormats.length > 0 ? 'flex' : 'none';
            
            const fileName = audioData.name.replace(/\.[^/.]+$/, '');
            const chunks = output.chunks || [];
            const language = languageSelect.value === 'auto' ? null : languageSelect.value;
            
            selectedFormats.forEach(format => {
                let content = '';
                let filename = '';
                let mimeType = '';
                
                switch(format) {
                    case 'txt':
                        content = text;
                        filename = `${fileName}.txt`;
                        mimeType = 'text/plain';
                        break;
                    case 'json':
                        content = JSON.stringify({
                            text: text,
                            chunks: chunks,
                            language: language || 'auto',
                            model: modelName
                        }, null, 2);
                        filename = `${fileName}.json`;
                        mimeType = 'application/json';
                        break;
                    case 'srt':
                        content = generateSRT(chunks);
                        filename = `${fileName}.srt`;
                        mimeType = 'text/srt';
                        break;
                    case 'vtt':
                        content = generateVTT(chunks);
                        filename = `${fileName}.vtt`;
                        mimeType = 'text/vtt';
                        break;
                    case 'tsv':
                        content = generateTSV(chunks);
                        filename = `${fileName}.tsv`;
                        mimeType = 'text/tab-separated-values';
                        break;
                }
                
                if (content) {
                    const btn = document.createElement('button');
                    btn.className = 'download-btn';
                    btn.textContent = `–°–∫–∞—á–∞—Ç—å ${format.toUpperCase()}`;
                    btn.onclick = () => downloadFile(content, filename, mimeType);
                    downloadButtons.appendChild(btn);
                }
            });
            
            isProcessing = false;
            transcribeBtn.disabled = false;
            stopBtn.disabled = true;
            progress.classList.remove('active');
        }
        
        stopBtn.addEventListener('click', () => {
            isProcessing = false;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Worker –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
            if (worker) {
                worker.postMessage({ type: 'stop' });
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏ —Ç–∞–π–º–∞—É—Ç—ã
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            if (transcriptionTimeout) {
                clearTimeout(transcriptionTimeout);
                transcriptionTimeout = null;
            }
            transcribeBtn.disabled = false;
            stopBtn.disabled = true;
            progress.classList.remove('active');
            progressBar.style.width = '0%';
            showStatus('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'info');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
        window.addEventListener('error', (event) => {
            console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', event.error);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
            setTimeout(() => {
                try {
                    if (isProcessing) {
                        showStatus('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å tiny.', 'error');
                        isProcessing = false;
                        if (transcribeBtn) transcribeBtn.disabled = false;
                        if (stopBtn) stopBtn.disabled = true;
                        if (progress) {
                            progress.classList.remove('active');
                            if (progressBar) progressBar.style.width = '0%';
                        }
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:', e);
                }
            }, 0);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–∏—Å–∞:', event.reason);
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            try {
                if (isProcessing) {
                    showStatus('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å tiny.', 'error');
                    isProcessing = false;
                    if (transcribeBtn) transcribeBtn.disabled = false;
                    if (stopBtn) stopBtn.disabled = true;
                    if (progress) {
                        progress.classList.remove('active');
                        if (progressBar) progressBar.style.width = '0%';
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:', e);
            }
        });
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
        let lastMainThreadCheck = Date.now();
        setInterval(() => {
            const now = Date.now();
            const timeSinceCheck = now - lastMainThreadCheck;
            if (timeSinceCheck > 5000 && isProcessing) {
                console.warn('–í–æ–∑–º–æ–∂–Ω–æ–µ –∑–∞–≤–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞');
                showStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å tiny –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.', 'info');
            }
            lastMainThreadCheck = now;
        }, 1000);

        async function transcribe() {
            if (!audioData) {
                showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
                return;
            }

            // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Web Worker –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
            const useWorker = initWorker();
            
            if (useWorker) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Web Worker —Ä–µ–∂–∏–º
                await transcribeWithWorker();
                return;
            }
            
            // Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –µ—Å–ª–∏ Worker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            await transcribeDirect();
        }
        
        async function transcribeWithWorker() {
            isProcessing = true;
            transcribeBtn.disabled = true;
            stopBtn.disabled = false;
            result.classList.remove('active');
            progress.classList.add('active');
            progressBar.style.width = '10%';
            
            try {
                const modelName = modelSelect.value;
                let language = null;
                if (languageSelect.value !== 'auto') {
                    language = languageSelect.value; // 'ru' –∏–ª–∏ 'en'
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å –≤ Worker
                worker.postMessage({ 
                    type: 'load', 
                    data: { modelName } 
                });
                
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏
                await new Promise((resolve) => {
                    const listener = (e) => {
                        if (e.data.type === 'modelLoaded') {
                            worker.removeEventListener('message', listener);
                            resolve();
                        }
                    };
                    worker.addEventListener('message', listener);
                });
                
                // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è –∞—É–¥–∏–æ
                const audioUrl = URL.createObjectURL(audioData);
                
                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
                const config = modelConfigs[modelName] || modelConfigs['Xenova/whisper-base'];
                
                // –ü–æ–ª—É—á–∞–µ–º task –∏–∑ UI
                const task = taskSelect.value; // 'transcribe' –∏–ª–∏ 'translate'
                
                const transcriptionOptions = {
                    ...config,
                    return_timestamps: true,
                    task: task,
                };
                
                if (language) {
                    transcriptionOptions.language = language;
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤ Worker
                worker.postMessage({ 
                    type: 'transcribe', 
                    data: { audioUrl, options: transcriptionOptions } 
                });
                
                // URL –±—É–¥–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ handleTranscriptionResult
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —á–µ—Ä–µ–∑ Worker:', error);
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
                isProcessing = false;
                transcribeBtn.disabled = false;
                stopBtn.disabled = true;
                progress.classList.remove('active');
            }
        }
        
        async function transcribeDirect() {
            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
            if (transcriptionTimeout) {
                clearTimeout(transcriptionTimeout);
                transcriptionTimeout = null;
            }
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }

            isProcessing = true;
            transcribeBtn.disabled = true;
            stopBtn.disabled = false;
            result.classList.remove('active');
            progress.classList.add('active');
            progressBar.style.width = '10%';
            
            let lastProgressUpdate = Date.now();
            
            // Heartbeat –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏–π
            heartbeatInterval = setInterval(() => {
                if (!isProcessing) {
                    clearInterval(heartbeatInterval);
                    heartbeatInterval = null;
                    return;
                }
                
                const now = Date.now();
                const timeSinceUpdate = now - lastProgressUpdate;
                
                // –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –±–æ–ª–µ–µ 30 —Å–µ–∫—É–Ω–¥ - –≤–æ–∑–º–æ–∂–Ω–æ–µ –∑–∞–≤–∏—Å–∞–Ω–∏–µ
                if (timeSinceUpdate > 30000) {
                    console.warn('–í–æ–∑–º–æ–∂–Ω–æ–µ –∑–∞–≤–∏—Å–∞–Ω–∏–µ: –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è', timeSinceUpdate, '–º—Å');
                    showStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å...', 'info');
                }
            }, HEARTBEAT_INTERVAL);

            try {
                const modelName = modelSelect.value;
                const task = taskSelect.value; // 'transcribe' –∏–ª–∏ 'translate'
                let language = null;
                
                if (languageSelect.value !== 'auto') {
                    language = languageSelect.value;
                }
                
                // –î–ª—è english-only –º–æ–¥–µ–ª–µ–π —è–∑—ã–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å null –∏–ª–∏ 'en'
                if (modelName.includes('.en') && language && language !== 'en') {
                    showStatus('English-only –º–æ–¥–µ–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', 'error');
                    isProcessing = false;
                    transcribeBtn.disabled = false;
                    stopBtn.disabled = true;
                    progress.classList.remove('active');
                    return;
                }

                // –í–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
                validateModel(modelName);
                
                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∫–∞—á–µ—Å—Ç–≤–µ base –º–æ–¥–µ–ª–∏ –∏ –¥–ª–∏–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
                if (modelName === 'Xenova/whisper-base' && audioData) {
                    const fileSizeMB = audioData.size / (1024 * 1024);
                    const estimatedDuration = fileSizeMB * 0.5; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞: ~0.5 –º–∏–Ω –Ω–∞ –ú–ë
                    
                    if (estimatedDuration > 10) {
                        showStatus('‚ö†Ô∏è –î–ª–∏–Ω–Ω—ã–π —Ñ–∞–π–ª. Base –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –¥–∞—Ç—å –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Tiny –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–ª–∏ Small/Medium –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞.', 'info');
                        await new Promise(resolve => setTimeout(resolve, 3000)); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ 3 —Å–µ–∫—É–Ω–¥—ã
                    } else {
                        showStatus('‚ö†Ô∏è Base –º–æ–¥–µ–ª—å –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ. –î–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Small –∏–ª–∏ Medium.', 'info');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }

                // –°–æ–∑–¥–∞—ë–º pipeline —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–º–µ–Ω–µ –º–æ–¥–µ–ª–∏
                if (!transcriber || currentModel !== modelName) {
                    showStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ ${modelName}...`, 'info');
                    progressBar.style.width = '20%';

                    try {
                        transcriber = await pipeline('automatic-speech-recognition', modelName, {
                            progress_callback: (progress) => {
                                if (progress.status === 'progress') {
                                    // progress.progress –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç 0 –¥–æ 1 –∏–ª–∏ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
                                    let percent = progress.progress;
                                    if (percent <= 1) {
                                        percent = percent * 100; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –µ—Å–ª–∏ –æ—Ç 0 –¥–æ 1
                                    }
                                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ—Ç 0 –¥–æ 100
                                    percent = Math.max(0, Math.min(100, Math.round(percent)));
                                    
                                    // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä: 20% (–Ω–∞—á–∞–ª–æ) + –¥–æ 20% (–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏) = –º–∞–∫—Å–∏–º—É–º 40%
                                    const barPercent = 20 + (percent * 0.2);
                                    progressBar.style.width = `${barPercent}%`;
                                    showStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${percent}%`, 'info');
                                }
                            }
                        });
                        currentModel = modelName;
                    } catch (modelError) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', modelError);
                        throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å: ${modelError.message}`);
                    }
                } else {
                    showStatus('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å', 'info');
                }

                progressBar.style.width = '40%';
                showStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...', 'info');

                // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞
                const audioUrl = URL.createObjectURL(audioData);
                progressBar.style.width = '50%';

                const taskName = task === 'translate' ? '–ü–µ—Ä–µ–≤–æ–¥' : '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è';
                showStatus(`${taskName}...`, 'info');

                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏
                const config = modelConfigs[modelName] || modelConfigs['Xenova/whisper-base'] || modelConfigs['Xenova/whisper-base.en'];

                // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤–æ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
                // callback_function –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –¥–ª—è ASR pipeline –≤ Transformers.js
                let simulatedProgress = 50; // –ù–∞—á–∏–Ω–∞–µ–º —Å 50%
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –±—ã–ª
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 200–º—Å
                progressInterval = setInterval(() => {
                    if (!isProcessing) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                        return;
                    }
                    simulatedProgress = Math.min(95, simulatedProgress + 0.5);
                    progressBar.style.width = `${simulatedProgress}%`;
                    
                    // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                    const elapsed = Math.floor((Date.now() - (lastProgressUpdate - 30000)) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    const taskName = task === 'translate' ? '–ü–µ—Ä–µ–≤–æ–¥' : '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è';
                    showStatus(`${taskName}... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ, –ø—Ä–æ—à–ª–æ: ${minutes}–º ${seconds}—Å, –ø—Ä–æ–≥—Ä–µ—Å—Å: ${Math.round(simulatedProgress)}%)`, 'info');
                    lastProgressUpdate = Date.now(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                }, 200);

                // –¢–∞–π–º–∞—É—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
                // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è Whisper –≤ Transformers.js
                const transcriptionOptions = {
                    ...config,
                    return_timestamps: true,
                    task: task, // 'transcribe' –∏–ª–∏ 'translate'
                };
                
                // –Ø–∑—ã–∫ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ auto –∏ –µ—Å–ª–∏ –º–æ–¥–µ–ª—å multilingual
                if (language && !modelName.includes('.en')) {
                    transcriptionOptions.language = language;
                }
                
                const transcriptionPromise = transcriber(audioUrl, transcriptionOptions);

                const timeoutPromise = new Promise((_, reject) => {
                    transcriptionTimeout = setTimeout(() => {
                        reject(new Error('–¢–∞–π–º–∞—É—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω—è–ª–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏–ª–∏ –º–æ–¥–µ–ª—å tiny/base.'));
                    }, TRANSCRIPTION_TIMEOUT);
                });

                // –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                const output = await Promise.race([transcriptionPromise, timeoutPromise]);
                
                // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–∞—É—Ç –µ—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ
                if (transcriptionTimeout) {
                    clearTimeout(transcriptionTimeout);
                    transcriptionTimeout = null;
                }

                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }

                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
                URL.revokeObjectURL(audioUrl);

                if (!isProcessing) return;

                progressBar.style.width = '100%';
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                const text = output.text || (output.chunks ? output.chunks.map(c => c.text).join(' ') : '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                if (text && text.length > 0) {
                    const wordCount = text.split(/\s+/).length;
                    const charCount = text.length;
                    
                    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ - –≤–æ–∑–º–æ–∂–Ω–æ –ø–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
                    if (modelName === 'Xenova/whisper-base' && charCount < 100 && audioData.size > 5 * 1024 * 1024) {
                        showStatus('–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∏–∑–∫–∏–º. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Small –∏–ª–∏ Medium –º–æ–¥–µ–ª—å –¥–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.', 'info');
                    } else {
                        showStatus(`–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${wordCount} —Å–ª–æ–≤.`, 'success');
                    }
                } else {
                    showStatus('–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª.', 'error');
                }
                
                resultText.textContent = text;
                result.classList.add('active');
                
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
                const selectedFormats = Array.from(formatsContainer.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                
                downloadButtons.innerHTML = '';
                downloadButtons.style.display = selectedFormats.length > 0 ? 'flex' : 'none';
                
                const fileName = audioData.name.replace(/\.[^/.]+$/, '');
                const chunks = output.chunks || [];
                
                selectedFormats.forEach(format => {
                    let content = '';
                    let filename = '';
                    let mimeType = '';
                    
                    switch(format) {
                        case 'txt':
                            content = text;
                            filename = `${fileName}.txt`;
                            mimeType = 'text/plain';
                            break;
                        case 'json':
                            content = JSON.stringify({
                                text: text,
                                chunks: chunks,
                                language: language || 'auto',
                                model: modelName
                            }, null, 2);
                            filename = `${fileName}.json`;
                            mimeType = 'application/json';
                            break;
                        case 'srt':
                            content = generateSRT(chunks);
                            filename = `${fileName}.srt`;
                            mimeType = 'text/srt';
                            break;
                        case 'vtt':
                            content = generateVTT(chunks);
                            filename = `${fileName}.vtt`;
                            mimeType = 'text/vtt';
                            break;
                        case 'tsv':
                            content = generateTSV(chunks);
                            filename = `${fileName}.tsv`;
                            mimeType = 'text/tab-separated-values';
                            break;
                    }
                    
                    if (content) {
                        const btn = document.createElement('button');
                        btn.className = 'download-btn';
                        btn.textContent = `–°–∫–∞—á–∞—Ç—å ${format.toUpperCase()}`;
                        btn.onclick = () => downloadFile(content, filename, mimeType);
                        downloadButtons.appendChild(btn);
                    }
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:', error);
                
                // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                let errorMessage = error.message;
                if (error.message.includes('timeout') || error.message.includes('–¢–∞–π–º–∞—É—Ç')) {
                    errorMessage = '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–Ω—è–ª–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å tiny –∏–ª–∏ base\n- –†–∞–∑–¥–µ–ª–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ —á–∞—Å—Ç–∏\n- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
                } else if (error.message.includes('memory') || error.message.includes('Memory')) {
                    errorMessage = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –º–æ–¥–µ–ª—å tiny –∏–ª–∏ –∑–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
                }
                
                showStatus(`–û—à–∏–±–∫–∞: ${errorMessage}`, 'error');
                
                // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤–∏–¥–∏–º—ã–º –ø—Ä–∏ –æ—à–∏–±–∫–µ –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    progress.classList.remove('active');
                    progressBar.style.width = '0%';
                }, 3000);
            } finally {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏ —Ç–∞–π–º–∞—É—Ç—ã
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                if (heartbeatInterval) {
                    clearInterval(heartbeatInterval);
                    heartbeatInterval = null;
                }
                if (transcriptionTimeout) {
                    clearTimeout(transcriptionTimeout);
                    transcriptionTimeout = null;
                }
                isProcessing = false;
                transcribeBtn.disabled = false;
                stopBtn.disabled = true;
                // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏ (–ø—Ä–∏ –æ—à–∏–±–∫–µ —É–∂–µ —Å–∫—Ä—ã–ª–∏ –≤ catch)
                if (progress.classList.contains('active')) {
                    progress.classList.remove('active');
                    progressBar.style.width = '0%';
                }
            }
        }


        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
        }
    </script>
</body>
</html>

